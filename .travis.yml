sudo: required
#可以在docker上跑
services:
  - docker
  - rabbitmq
  - mysql
  - redis-server
language: ruby
#测试在docker上跑
before_install:
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-engine #
  - docker pull carlad/sinatra
  - docker run -d -p 127.0.0.1:80:4567 carlad/sinatra /bin/sh -c "cd /root/sinatra; bundle exec foreman start;"
  - docker ps -a
  - docker run carlad/sinatra /bin/sh -c "cd /root/sinatra; bundle exec rake test"
  - mysql -e 'CREATE DATABASE sample_app_test;'
rvm:
  - 2.3.1
  - 2.4.1
cache:
  timeout: 1000
  bundler: true
  directories:
    - flow_test

install:
  - bundle install
  
script:
  - bundle exec rake db:migrate
  - bundle exec rake test
  - bundle exec rake test:$TEST_SUITE
  #/test.sh
before_deploy: "echo 'ready deploy...'"  
  
deploy:
 #- provider: ddd
  # email: "aaa"
   #password: "aaa" #加密的  travis encrypt "YOUR PASSWORD" --add deploy.password
 - provider: heroku
   api_key: "aaaaaaa" #travis encrypt $(heroku auth:token) --add deploy.api_key
   on:
     all_branches: true
   run:
     - "rake db:migrate"
     - restart
     - "rake cleanup"
 #prevent Travis CI from resetting your working directory and deleting all changes made during the build
  skip_cleanup: true
  
after_deploy:
  - ./after_deploy_1.sh
  - ./after_deploy_2.sh
git:
  depth: 3
  
branches:
  only:
    - master
    #提供正则匹配分支
    #- /^char.*$/
bundler_args: --without development debug #不安装debug gem
bundler_args: --retry 5 #如果网络超时，可以retry
env: #可以分开跑测试
  - TEST_SUITE=models
  - TEST_SUITE=integeration
  
    
    

